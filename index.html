<html>
<head>
  <base target="_blank" />
  <title>Ferramentas de Texto</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="importmap">
    {
      "imports": {
        "./navigation.js": "./navigation.js",
        "./addressGenerator.js": "./addressGenerator.js",
        "./nameModifier.js": "./nameModifier.js",
        "./planoB.js": "./planoB.js"
      }
    }
  </script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="main-header">
    <div class="header-content-left">
        <nav>
            <button id="nav-address" class="active" onclick="navigation.showTool('address-generator')">Gerador de Endere√ßos</button>
            <button id="nav-name" onclick="navigation.showTool('name-modifier')">Modificador de Nomes</button>
            <button id="nav-plano">Plano-B</button>
            <button id="nav-clean" onclick="navigation.showTool('clean-generator')">Clean</button>
            <div id="theme-toggle" title="Alterar Tema">‚òØ</div>
        </nav>
        <div id="backup-controls">
            <button id="create-backup-btn">Criar Backup</button>
            <button id="import-backup-btn">Importar Backup</button>
            <button id="kill-mode-btn">KILL</button>
            <button id="email-link-btn" title="Abrir planilha de emails">üìß</button>
            <input type="file" id="backup-file-input" style="display: none;" accept=".json,application/json">
        </div>
        <!-- New Prefix Controls -->
        <div id="prefix-controls">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="prefix-toggle-checkbox" checked>
            <label for="prefix-toggle-checkbox" title="Ativar/Desativar prefixos autom√°ticos (ex: 'enviado para')">Usar Prefixo</label>
          </div>
          <div class="checkbox-wrapper">
            <input type="checkbox" id="clean-street-toggle-checkbox">
            <label for="clean-street-toggle-checkbox" title="Se selecionado, a varia√ß√£o da rua n√£o ser√° modificada.">Rua Limpa</label>
          </div>
          <button id="prefix-menu-btn" title="Configurar Frases de Prefixo">üë©‚Äçüè´</button>
          <button id="cyborg-mode-btn" title="Ativar/Desativar Modo Ciborgue">‚ö°Ô∏è</button>
        </div>
        <!-- New History Controls -->
        <div id="history-controls">
            <button id="undo-btn" title="Desfazer (Voltar)">‚Ü∂</button>
            <button id="redo-btn" title="Refazer (Avan√ßar)">‚Ü∑</button>
        </div>
    </div>
    <div id="ip-widget">
        <div id="help-button" title="Ajuda">?</div>
        <div id="ip-eye" title="Mostrar IP">üëÅÔ∏è</div>
        <div id="ip-display" style="display: none;"></div>
    </div>
  </header>

  <div id="address-generator" class="tool-container">
    <h2 id="address-generator-title">Gerador_CH_3.0</h2>

    <div class="ball-container">
      <!-- Balls will be dynamically added here -->
      <div id="balls-content-container" class="ball-group-container"></div>
    </div>
     <!-- New Reorder Controls -->
    <div id="reorder-controls" style="display: none;">
        <button id="finish-reorder-btn">‚úì Concluir Reordena√ß√£o</button>
    </div>

    <div class="input-section">
      <label for="originalText">Texto Original:</label>
      <textarea id="originalText" rows="5" style="width: 100%;"></textarea>

      <label for="count">Quantidade de varia√ß√µes:</label>
      <input type="number" id="count" value="10" min="1" max="20">

      <button onclick="addressGenerator.generateVariations()">Gerar Varia√ß√µes</button>
    </div>

    <div id="output" class="output">
        <!-- Variations will be displayed here -->
    </div>

    <!-- Robot Sequencer Section -->
    <div id="robot-section">
      <div id="sequencer-toggles">
        <div id="robot-toggle" title="Abrir Sequenciador Rob√¥">ü§ñ</div>
        <div id="wizard-toggle" title="Abrir Sequenciador Mago">üßô</div>
      </div>
      <div id="robot-sequencer" style="display: none;">
        <!-- New Ball Filter -->
        <div id="robot-view-filter-container">
            <div id="robot-view-filter">
                <div id="filter-blue" class="filter-ball active" data-filter="blue" title="Ver bolinhas azuis"></div>
                <div id="filter-black" class="filter-ball" data-filter-black title="Ver bolinhas pretas"></div>
            </div>
             <!-- New Ball Selector Panel -->
            <div id="robot-ball-selector">
                <!-- Small selector balls will be populated here by JS -->
            </div>
        </div>
       
        <!-- Main Robot Controls -->
        <div id="robot-main-controls">
            <div id="robot-ball-display-container">
                <div id="robot-ball-display" class="ball" title="Clique para copiar dados"></div>
            </div>
            <button id="robot-next-btn">Pr√≥ximo</button>
        </div>
      </div>
      <!-- Wizard Sequencer Section -->
      <div id="wizard-sequencer" style="display: none;">
        <div id="wizard-view-filter-container">
            <div id="wizard-view-filter">
                <div id="filter-blue-wizard" class="filter-ball active" data-filter="blue" title="Ver bolinhas azuis"></div>
                <div id="filter-black-wizard" class="filter-ball" data-filter-black title="Ver bolinhas pretas"></div>
            </div>
            <div id="wizard-ball-selector">
                <!-- Small selector balls will be populated here by JS -->
            </div>
        </div>
        <div id="wizard-main-controls">
            <div id="wizard-ball-display-container">
                <div id="wizard-ball-display" class="ball" title="Clique para copiar dados"></div>
            </div>
            <button id="wizard-next-btn">Pr√≥ximo</button>
        </div>
      </div>
      <!-- End Wizard Sequencer Section -->
      <!-- New Batch Generator Button -->
      <div id="batch-generate-controls" title="Gerador em Lote">
        <button id="batch-generate-btn">üíæü§ñ</button>
      </div>
      <div id="robot-feedback" style="display: none;"></div>
    </div>
    <!-- End Robot Sequencer Section -->
  </div>

  <div id="name-modifier" class="tool-container" style="display: none;">
     <h2>Modificador de Nomes</h2>
     <input type="text" id="nomeInput" placeholder="Digite o nome completo">
     <div class="button-container">
       <button onclick="nameModifier.modificarNome()">Modificar Nome</button>
       <button onclick="nameModifier.resetNome()">Resetar Nome</button>
       <button id="db-toggle-button">Banco de Dados</button>
       <button id="get-new-name-button" onclick="nameModifier.getNewName()">Novo Nome</button>
     </div>
     <div id="resultado"></div>

     <div id="database-section" style="display: none;">
        <h3>Banco de Dados</h3>
        <div id="db-stats-panel">
            <span>Nomes V√°lidos: <strong id="valid-names-count">0</strong></span>
            <span>Dispon√≠veis: <strong id="available-names-count">0</strong></span>
        </div>
        <textarea id="db-input" rows="5" placeholder="Cole o texto aqui para salvar..."></textarea>
        <div class="db-button-container">
           <button id="db-save-button">Salvar no Banco</button>
           <button id="db-clear-button">Limpar Banco</button>
        </div>
        <h4>Dados Salvos:</h4>
        <div id="stored-data-display"></div>
     </div>

     <!-- New Complement Modifier Section -->
     <div id="complemento-modifier" class="tool-section">
        <h3>Modificador de Complemento</h3>
        <textarea id="complementoOriginal" rows="3" placeholder="Cole o texto do complemento aqui..."></textarea>
        <div class="complemento-controls">
            <label for="complementoCount">Quantidade de varia√ß√µes:</label>
            <input type="number" id="complementoCount" value="5" min="1" max="20">
            <button id="gerarComplementoBtn">Gerar Modifica√ß√µes</button>
        </div>
        <div id="complementoOutput" class="output">
            <!-- Complement variations will be displayed here -->
        </div>
     </div>
     <!-- End New Complement Modifier Section -->
  </div>

  <!-- New Plano-B Tool Container -->
  <div id="plano-b" class="tool-container" style="display: none;">
    <h2>Plano-B</h2>
    <div class="button-container" id="plano-b-controls">
      <!-- Buttons are now generated by planoB.js to ensure clean state -->
    </div>
    <div id="plano-b-output" class="output">
        <!-- Content from Plano-B buttons will be displayed here -->
    </div>
  </div>

  <!-- New Clean Generator Tool Container -->
  <div id="clean-generator" class="tool-container" style="display: none;">
      <div class="clean-container">
        <!-- Header -->
        <div class="clean-header">
          <h1 class="clean-title">Gerador de Varia√ß√µes de Nomes de Ruas</h1>
          <div class="clean-subtitle">Sem repeti√ß√µes ‚Ä¢ Gera 100 at√© 1000+ itens</div>
        </div>

        <!-- Controls Card -->
        <div class="clean-card">
          <div class="clean-controls-grid">
            <div class="clean-control-group">
              <label for="clean-base-names" class="clean-label">Nomes base (um por linha ou separados por v√≠rgula)</label>
              <textarea
                id="clean-base-names"
                class="clean-textarea"
                placeholder="Ex.: Rua Tacaratu Marques&#10;Rua dos Palmares&#10;Avenida Dom Pedro"
              >Rua Tacaratu Marques</textarea>
              <p class="clean-hint">Dica: voc√™ pode colar uma lista grande de ruas aqui.</p>
            </div>
            <div class="clean-options-grid">
              <div class="clean-control-group">
                <label for="clean-quantity" class="clean-label">Quantidade desejada</label>
                <input
                  type="number"
                  id="clean-quantity"
                  class="clean-input"
                  min="1"
                  max="10000"
                  value="200"
                />
                <span class="clean-hint">Ex.: 100, 200, 300, ... 1000</span>
              </div>
              <div class="clean-control-group">
                <label for="clean-style" class="clean-label">Estilo</label>
                <select id="clean-style" class="clean-select">
                  <option value="realista">Realista (mudan√ßas leves)</option>
                  <option value="criativa">Criativa (mais varia√ß√µes)</option>
                  <option value="mista" selected>Mista</option>
                </select>
                <label class="clean-checkbox-label">
                  <input type="checkbox" id="clean-include-type" checked />
                  Incluir tipo de logradouro (Rua, Avenida, etc.)
                </label>
                <div class="clean-control-group" style="margin-top: 10px;">
                  <label for="clean-seed" class="clean-label">Semente (opcional)</label>
                  <input
                    type="text"
                    id="clean-seed"
                    class="clean-input"
                    placeholder="Use para repetir um resultado"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="clean-actions">
            <button id="clean-generate-btn" class="clean-btn primary">
              <span class="icon">üîÄ</span> Gerar varia√ß√µes
            </button>
            <button id="clean-robot-mode-btn" class="clean-btn" title="Ativar/Desativar Modo Rob√¥">
              <span class="icon">ü§ñ</span> Modo Rob√¥
            </button>
            <button id="clean-clear-btn" class="clean-btn">
              <span class="icon">üóëÔ∏è</span> Limpar
            </button>
            <button id="clean-copy-btn" class="clean-btn" disabled>
              <span class="icon">üìã</span> Copiar
            </button>
            <button id="clean-download-txt-btn" class="clean-btn" disabled>
              <span class="icon">üíæ</span> Baixar .TXT
            </button>
            <button id="clean-download-csv-btn" class="clean-btn" disabled>
              <span class="icon">üíæ</span> Baixar .CSV
            </button>
          </div>
        </div>

        <!-- Results -->
        <div class="clean-card">
          <div class="clean-results-header">
            <h2 class="clean-section-title">Resultados (<span id="clean-results-count">0</span>)</h2>
            <button id="clean-sort-btn" class="clean-sort-link">
              Ordenar A‚ÜíZ
            </button>
          </div>
          <div id="clean-results-output">
             <p class="clean-hint">Nenhuma varia√ß√£o gerada ainda. Clique em "Gerar varia√ß√µes".</p>
             <ol id="clean-results-list" class="clean-results-list"></ol>
          </div>
        </div>

        <!-- New Ball Picker Panel -->
        <div class="clean-card">
          <h2 class="clean-section-title">Selecionar Endere√ßo Base de uma Bolinha</h2>
          <p class="clean-hint">Clique em uma bolinha para usar o endere√ßo e n√∫mero dela como base para a gera√ß√£o.</p>
          <div id="clean-ball-container" class="ball-group-container">
            <!-- Balls from addressGenerator will be rendered here by clean.js -->
          </div>
        </div>
        <!-- End New Ball Picker Panel -->

        <!-- Footer -->
        <div class="clean-footer">
          Dica: para gerar MUITAS varia√ß√µes (ex.: 1000+), adicione mais nomes base e use o estilo "Mista" com logradouro ativado.
        </div>
      </div>
  </div>

  <!-- New Prefix Menu Modal -->
  <div id="prefix-menu-modal" class="modal" style="display: none;">
      <div class="modal-content">
          <span class="close-button prefix-menu-close">&times;</span>
          <h2>Gerenciador de Frases de Prefixo</h2>
          <div class="modal-body" id="prefix-modal-body">
              <p>Selecione as categorias de frases que deseja incluir nas gera√ß√µes de endere√ßo. As altera√ß√µes s√£o salvas automaticamente.</p>
              
              <!-- Categories will be populated by JS -->

              <hr>
              <div class="prefix-option english-option">
                  <input type="checkbox" id="prefix-english-checkbox">
                  <label for="prefix-english-checkbox"><span>üü¶</span> Incluir tradu√ß√µes em Ingl√™s (English)</label>
              </div>
          </div>
      </div>
  </div>

  <!-- New Emoji Picker Modal -->
  <div id="emoji-picker-modal" class="modal" style="display: none;">
    <div class="modal-content emoji-modal-content">
      <span class="close-button emoji-close">&times;</span>
      <h2>Selecione um Emoji</h2>
      <div class="modal-body">
        <emoji-picker class="dark"></emoji-picker>
      </div>
    </div>
  </div>

  <!-- New Batch Generator Modal -->
  <div id="batch-generator-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button batch-close">&times;</span>
      <h2>Gerador em Lote</h2>
      <div class="modal-body">
        <div id="batch-generator-form">
          <div class="batch-control-group">
            <label for="batch-quantity">Quantidade de modifica√ß√µes:</label>
            <input type="number" id="batch-quantity" value="10" min="1">
          </div>
          <div class="batch-control-group">
            <p>Selecionar bolinhas para usar:</p>
            <div id="batch-quick-select">
              <button id="batch-select-all">Todas</button>
              <button id="batch-select-blue">Azuis</button>
              <button id="batch-select-black">Pretas</button>
              <button id="batch-select-none">Nenhuma</button>
            </div>
          </div>
          <div id="batch-ball-list-container">
            <!-- Checkboxes will be populated here by JS -->
          </div>
          <div id="batch-action-container">
             <button id="batch-copy-btn">Gerar e Copiar</button>
             <p id="batch-feedback" class="feedback-message"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button help-close">&times;</span>
      <h2>Guia de Funcionalidades</h2>
      <div class="modal-body">
          <p>Bem-vindo ao Ferramentas de Texto! Aqui est√° um guia detalhado sobre como usar cada fun√ß√£o.</p>

          <h3>Navega√ß√£o e Controles Gerais</h3>
          <ul>
              <li><strong>Navega√ß√£o Principal</strong>: Use os bot√µes <strong>"Gerador de Endere√ßos"</strong>, <strong>"Modificador de Nomes"</strong> e <strong>"Plano-B"</strong> no topo da p√°gina para alternar entre as ferramentas. O "Plano-B" requer uma senha na primeira vez que for acessado.</li>
              <li><strong>Alterar Tema (‚òØ)</strong>: Clique no √≠cone Yin-Yang para alternar entre os temas claro e escuro.</li>
              <li><strong>Backup e Restaura√ß√£o</strong>:
                  <ul>
                      <li><strong>Criar Backup</strong>: Salva todos os seus dados (endere√ßos, banco de nomes, configura√ß√µes) em um arquivo <code>.json</code>.</li>
                      <li><strong>Importar Backup</strong>: Carrega um arquivo de backup, substituindo os dados atuais. A p√°gina ser√° recarregada.</li>
                  </ul>
              </li>
              <li><strong>Desfazer (‚Ü∂) / Refazer (‚Ü∑)</strong>: Permite voltar ou avan√ßar entre estados salvos da aplica√ß√£o. Exige senha para confirmar a a√ß√£o.</li>
              <li><strong>Widget de IP (üëÅÔ∏è)</strong>: Clique no olho no canto superior direito para revelar seu endere√ßo de IP p√∫blico. Clique novamente para ocult√°-lo.</li>
              <li><strong>Ajuda (?)</strong>: Voc√™ est√° lendo! Clique neste bot√£o a qualquer momento para ver este guia.</li>
          </ul>

          <hr>

          <h3>Gerador de Endere√ßos (<code>Gerador_CH_3.0</code>)</h3>
          <p>Esta ferramenta permite carregar modelos de endere√ßo e gerar varia√ß√µes aleat√≥rias da linha de endere√ßo para testes.</p>
          <ul>
              <li><strong>Bolinhas de Endere√ßo</strong>: Clique em uma bolinha (azul para num√©ricas, preta para √≠cones) para carregar seu respectivo modelo de endere√ßo no campo "Texto Original". Clique com o bot√£o direito em uma bolinha para ver op√ß√µes como editar, bloquear ou excluir.</li>
              <li><strong>Adicionar Nova Bolinha (+)</strong>: Clique na bolinha verde para adicionar um novo endere√ßo.</li>
              <li><strong>Gerar Varia√ß√µes</strong>: Ap√≥s carregar um endere√ßo, ajuste a "Quantidade de varia√ß√µes" e clique em "Gerar Varia√ß√µes". O sistema encontrar√° a linha "Endere√ßo:" no texto e criar√° vers√µes modificadas.</li>
              <li><strong>KILL (Bot√£o de Sangue)</strong>: Ativa um modo de gera√ß√£o "criativo" que usa caracteres especiais, Leetspeak (ex: 4 para A) e formata√ß√£o incomum. Requer senha para ativar/desativar.</li>
              <li><strong>Usar Prefixo (Checkbox)</strong>: Quando marcado, adiciona frases como "enviar para", "destinado a", etc., antes da varia√ß√£o do endere√ßo.</li>
              <li><strong>Rua Limpa (Checkbox)</strong>: Quando marcado, a parte do endere√ßo da rua n√£o √© modificada, resultando em uma "rua limpa". O prefixo (se ativo) ainda ser√° adicionado.</li>
              <li><strong>Configurar Frases (üë©‚Äçüè´)</strong>: Abre um menu para selecionar categorias de frases de prefixo e ativar tradu√ß√µes em ingl√™s.</li>
              <li><strong>Modo Ciborgue (Bot√£o Chihuahua-Rob√¥)</strong>: Quando ativado, clicar em "Copiar" em uma varia√ß√£o gerada ir√° copiar um bloco de dados completo: um nome/CPF aleat√≥rio do banco de dados, um telefone gerado, e o endere√ßo com a varia√ß√£o selecionada e um complemento modificado.</li>
          </ul>
          <h4>Rob√¥ (ü§ñ) e Mago (üßô)</h4>
          <p>Fun√ß√µes avan√ßadas que combinam dados de v√°rias fontes para criar um pacote de informa√ß√µes completo e copi√°-lo para a √°rea de transfer√™ncia.</p>
          <ul>
              <li><strong>Abrir/Fechar</strong>: Clique no √≠cone do rob√¥ ou do mago para mostrar ou ocultar o respectivo painel.</li>
              <li><strong>Filtro de Vis√£o (bolinhas azul/preta)</strong>: Alterne entre a visualiza√ß√£o das bolinhas azuis (num√©ricas) e pretas (com √≠cones).</li>
              <li><strong>Painel de Sele√ß√£o</strong>: Clique em uma das bolinhas pequenas para selecion√°-la.</li>
              <li><strong>Bot√£o "Pr√≥ximo"</strong>: Avan√ßa para a pr√≥xima bolinha na sequ√™ncia.</li>
              <li><strong>Copiar Dados (Clicar na bolinha grande)</strong>: Ao clicar na bolinha grande, o sistema ir√°:
                  <ol>
                      <li>Buscar um nome, CPF, sexo e data de nascimento da ferramenta "Modificador de Nomes".</li>
                      <li>Gerar um n√∫mero de telefone aleat√≥rio.</li>
                      <li>Gerar uma varia√ß√£o do endere√ßo e do complemento da bolinha selecionada (o Mago adiciona sufixos especiais).</li>
                      <li>Combinar tudo e copiar para sua √°rea de transfer√™ncia.</li>
                  </ol>
              </li>
              <li><strong>Gerador em Lote (üíæü§ñ)</strong>: No painel do Rob√¥, este bot√£o abre um modo para gerar m√∫ltiplos pacotes de dados de uma s√≥ vez, a partir de uma sele√ß√£o de bolinhas.</li>
          </ul>

          <hr>

          <h3>Modificador de Nomes</h3>
          <p>Ferramenta para manipular nomes e complementos, al√©m de gerenciar um banco de dados local.</p>
          <ul>
              <li><strong>Modificar Nome</strong>: Digita um nome completo e formata-o com a capitaliza√ß√£o correta (ex: "jo√£o da silva" vira "Jo√£o da Silva").</li>
              <li><strong>Banco de Dados</strong>:
                  <ul>
                      <li>Clique em <strong>"Banco de Dados"</strong> para expandir/recolher a se√ß√£o.</li>
                      <li><strong>Salvar no Banco</strong>: Cole uma lista de registros (com "Nome:", "CPF:", etc.) e clique para salvar.</li>
                      <li><strong>Limpar Banco</strong>: Apaga todos os dados salvos.</li>
                      <li>√â poss√≠vel excluir registros individualmente clicando no 'X' vermelho ao lado de cada um (requer senha).</li>
                  </ul>
              </li>
               <li><strong>Novo Nome</strong>: Busca um registro aleat√≥rio do banco de dados (nascidos entre 1974-2004) e copia os dados formatados (CPF, Nome, Sexo, Nascimento) para a √°rea de transfer√™ncia.</li>
              <li><strong>Modificador de Complemento</strong>: Gere varia√ß√µes de um texto de complemento de endere√ßo (ex: "Apto 101 Bloco A").</li>
          </ul>
           
          <hr>

          <h3>Plano-B</h3>
          <p>Esta se√ß√£o cont√©m listas personalizadas para acesso r√°pido.</p>
          <ul>
              <li><strong>CEPs Coqueiral / Miguxos</strong>: Alterne entre as duas listas.</li>
              <li><strong>Copiar (üê∂)</strong>: Cada item possui um bot√£o de c√≥pia com o √≠cone de cachorro.</li>
              <li><strong>Adicionar Item (+)</strong>: Clique na bolinha verde com o sinal de mais no final da lista para adicionar um novo registro (requer senha).</li>
              <li><strong>Editar/Excluir</strong>: Clique com o bot√£o direito do mouse em qualquer item para abrir um menu com as op√ß√µes de editar ou excluir (requer senha).</li>
          </ul>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <script type="module">
    import * as navigation from './navigation.js';
    import * as addressGenerator from './addressGenerator.js';
    import * as nameModifier from './nameModifier.js';
    import * as planoB from './planoB.js';
    import * as clean from './clean.js';

    window.navigation = navigation;
    window.addressGenerator = addressGenerator;
    window.nameModifier = nameModifier;
    window.planoB = planoB;
    window.clean = clean;

    document.addEventListener('DOMContentLoaded', () => {
      navigation.showTool('address-generator'); 
      addressGenerator.initAddressGenerator(); 
      nameModifier.initNameModifier(); 
      planoB.initPlanoB();
      clean.initCleanGenerator();

      // --- Plano-B Unlock Logic ---
      const planoBNavBtn = document.getElementById('nav-plano');
      let planoBUnlocked = sessionStorage.getItem('planoBUnlocked') === 'true';

      if (!planoBUnlocked) {
        planoBNavBtn.classList.add('locked');
        planoBNavBtn.title = 'Clique para desbloquear';
      }

      planoBNavBtn.addEventListener('click', () => {
        if (!planoBUnlocked) {
          const pass = prompt("Para desbloquear o Plano-B, digite a senha:");
          if (pass === '019026') {
            planoBUnlocked = true;
            sessionStorage.setItem('planoBUnlocked', 'true');
            planoBNavBtn.classList.remove('locked');
            planoBNavBtn.title = '';
            navigation.showTool('plano-b');
          } else if (pass !== null) {
            alert("Senha incorreta.");
          }
        } else {
          navigation.showTool('plano-b');
        }
      });
      // --- End Plano-B Unlock Logic ---

      // --- THEME TOGGLE LOGIC ---
      const themeToggle = document.getElementById('theme-toggle');
      const body = document.body;

      // Function to apply theme based on saved preference
      const applyTheme = (theme) => {
          if (theme === 'dark') {
              body.classList.add('dark-theme');
          } else {
              body.classList.remove('dark-theme');
          }
      };

      // Apply saved theme on initial load
      const savedTheme = localStorage.getItem('theme') || 'light';
      applyTheme(savedTheme);

      // Add click listener to toggle the theme
      themeToggle.addEventListener('click', () => {
          const isDark = body.classList.toggle('dark-theme');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
      // --- END THEME TOGGLE LOGIC ---

      // --- New Email Link Button Logic ---
      const emailLinkBtn = document.getElementById('email-link-btn');
      if (emailLinkBtn) {
          emailLinkBtn.addEventListener('click', () => {
              window.open('https://docs.google.com/spreadsheets/d/1r179e5vtHYkArl8BrLoQ1fsX637kvVAVKkBf2tSqUKs/edit?hl=pt-br&gid=0#gid=0', '_blank');
          });
      }
      // --- End New Email Link Button Logic ---

      // IP Widget Logic
      const ipEye = document.getElementById('ip-eye');
      const ipDisplay = document.getElementById('ip-display');
      let ipAddressCache = null;

      ipEye.addEventListener('click', async () => {
          const isVisible = ipDisplay.style.display !== 'none';

          if (isVisible) {
              ipDisplay.style.display = 'none';
              ipEye.textContent = 'üëÅÔ∏è';
              ipEye.title = 'Mostrar IP';
          } else {
              ipDisplay.style.display = 'block';
              ipEye.textContent = 'üôà';
              ipEye.title = 'Ocultar IP';

              if (!ipAddressCache) {
                  ipDisplay.textContent = 'Buscando...';
                  try {
                      const response = await fetch('https://api.ipify.org?format=json');
                      if (!response.ok) throw new Error('Network error');
                      const data = await response.json();
                      ipAddressCache = data.ip;
                      ipDisplay.textContent = `IP: ${ipAddressCache}`;
                  } catch (error) {
                      console.error('Erro ao buscar IP:', error);
                      ipDisplay.textContent = 'Falha ao buscar IP';
                      // Don't cache on error, so it can retry on next click
                      ipAddressCache = null; 
                  }
              } else {
                  ipDisplay.textContent = `IP: ${ipAddressCache}`;
              }
          }
      });

      // Help Modal Logic
      const helpButton = document.getElementById('help-button');
      const helpModal = document.getElementById('help-modal');
      const closeButton = document.querySelector('.close-button.help-close');

      helpButton.addEventListener('click', () => {
          helpModal.style.display = 'flex';
      });

      closeButton.addEventListener('click', () => {
          helpModal.style.display = 'none';
      });

      // Close modal if user clicks outside of the content area
      window.addEventListener('click', (event) => {
          if (event.target == helpModal) {
              helpModal.style.display = 'none';
          }
      });

      // --- History (Undo/Redo) Logic ---
      let historyStack = [];
      let redoStack = [];
      const MAX_HISTORY = 30;
      const undoBtn = document.getElementById('undo-btn');
      const redoBtn = document.getElementById('redo-btn');

      const backupKeys = [
        'addressGenerator_addresses',
        'addressGenerator_lockedBalls',
        'addressGenerator_ballMeta',
        'addressGenerator_title',
        'addressGenerator_order',
        'nameModifierDatabase'
      ];
      
      // Load stacks from localStorage on page load
      const loadHistoryFromStorage = () => {
          try {
              const storedHistory = JSON.parse(localStorage.getItem('undo_historyStack') || '[]');
              const storedRedo = JSON.parse(localStorage.getItem('undo_redoStack') || '[]');
              historyStack = Array.isArray(storedHistory) ? storedHistory : [];
              redoStack = Array.isArray(storedRedo) ? storedRedo : [];
          } catch (e) {
              console.error("Could not load history from storage", e);
              historyStack = [];
              redoStack = [];
          }
      };
      
      // Save stacks to localStorage
      const saveHistoryToStorage = () => {
          localStorage.setItem('undo_historyStack', JSON.stringify(historyStack));
          localStorage.setItem('undo_redoStack', JSON.stringify(redoStack));
      };

      // Centralized state snapshot function
      const getAppState = () => {
          const state = {};
          backupKeys.forEach(key => {
              state[key] = localStorage.getItem(key); // Store raw string or null
          });
          return state;
      };

      // Centralized state restoration function
      const restoreAppState = (state) => {
          Object.keys(state).forEach(key => {
              if (state[key] !== null && state[key] !== undefined) {
                  localStorage.setItem(key, state[key]);
              } else {
                  // If key is null/undefined in the state object, remove it
                  localStorage.removeItem(key);
              }
          });
          // Stacks are already saved, now reload to apply state
          location.reload();
      };
      
      // Function to be called BEFORE a state change
      window.saveHistoryState = () => {
          if (historyStack.length >= MAX_HISTORY) {
              historyStack.shift(); // Remove oldest entry
          }
          historyStack.push(getAppState());
          redoStack.length = 0; // Clear redo stack on new action
          saveHistoryToStorage();
          updateHistoryButtons();
      };
      
      const updateHistoryButtons = () => {
          undoBtn.disabled = historyStack.length === 0;
          redoBtn.disabled = redoStack.length === 0;
      };
      
      function checkPassword() {
          const pass = prompt("Para esta a√ß√£o, por favor, digite a senha:");
          if (pass === '019026') return true;
          if (pass !== null) alert("Senha incorreta.");
          return false;
      }

      undoBtn.addEventListener('click', () => {
          if (historyStack.length > 0) {
              if (checkPassword()) {
                  redoStack.push(getAppState()); // Save current state for redo
                  const prevState = historyStack.pop();
                  saveHistoryToStorage(); // Save stacks before reload
                  restoreAppState(prevState);
              }
          }
      });
      
      redoBtn.addEventListener('click', () => {
          if (redoStack.length > 0) {
              if (checkPassword()) {
                  historyStack.push(getAppState()); // Save current state for undo
                  const nextState = redoStack.pop();
                  saveHistoryToStorage(); // Save stacks before reload
                  restoreAppState(nextState);
              }
          }
      });
      // --- End History Logic ---

      // --- Backup & Restore Logic ---
      const createBackupBtn = document.getElementById('create-backup-btn');
      const importBackupBtn = document.getElementById('import-backup-btn');
      const backupFileInput = document.getElementById('backup-file-input');

      createBackupBtn.addEventListener('click', () => {
        const backupData = {};
        backupKeys.forEach(key => {
          // Store the raw string from localStorage, or null if it doesn't exist.
          backupData[key] = localStorage.getItem(key);
        });

        const backupJson = JSON.stringify(backupData, null, 2);
        const blob = new Blob([backupJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const date = new Date();
        const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        a.download = `backup_ferramentas_texto_${dateString}.json`;
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('Backup criado com sucesso!');
      });

      importBackupBtn.addEventListener('click', () => {
        // Trigger the hidden file input
        backupFileInput.click();
      });

      backupFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
          return; // User cancelled
        }

        if (!confirm('Importar um backup substituir√° todos os dados atuais (endere√ßos e banco de dados de nomes). Deseja continuar?')) {
            // Reset file input value to allow selecting the same file again
            backupFileInput.value = '';
            return;
        }
        
        window.saveHistoryState(); // Save state before importing

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backupContent = e.target.result;
            const backupData = JSON.parse(backupContent);

            let importedKeysCount = 0;
            // Restore data from backup
            backupKeys.forEach(key => {
                if (backupData[key] !== undefined && backupData[key] !== null) {
                    localStorage.setItem(key, backupData[key]);
                    importedKeysCount++;
                } else {
                    // If a key is null or missing in the backup, remove it from localStorage
                    // to ensure a clean restore.
                    localStorage.removeItem(key);
                }
            });

            if (importedKeysCount > 0) {
                alert('Backup importado com sucesso! A p√°gina ser√° recarregada para aplicar as altera√ß√µes.');
                // Use location.reload() to force a complete refresh of the application state
                location.reload();
            } else {
                 alert('O arquivo de backup parece estar vazio ou em um formato inv√°lido. Nenhuma altera√ß√£o foi feita.');
            }

          } catch (error) {
            console.error('Erro ao importar o backup:', error);
            alert('Falha ao ler o arquivo de backup. Verifique se o arquivo √© um backup v√°lido e tente novamente.');
          } finally {
            // Reset file input value so the user can select the same file again if needed
            backupFileInput.value = '';
          }
        };

        reader.onerror = () => {
            alert('Ocorreu um erro ao tentar ler o arquivo.');
            backupFileInput.value = '';
        };

        reader.readAsText(file);
      });
      
      // Initialize history stacks from storage and update buttons on load
      loadHistoryFromStorage();
      updateHistoryButtons();

    });
  </script>
</body>
</html>